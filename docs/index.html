<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Retro Chat · 大厅</title>
<style>
  :root{--bg:#0b0f0c;--panel:#0e1310;--line:#213b2a;--txt:#c7f7c1;--muted:#86b28d;--accent:#91ff75}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 ui-monospace,Consolas,monospace;min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
  header{padding:12px 16px;background:linear-gradient(180deg,#0e1712,#0a0f0c);border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
  .brand{color:var(--accent);font-weight:700;letter-spacing:.08em}
  main{padding:16px;display:grid;gap:14px;align-content:start}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:10px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button{font:inherit;color:var(--txt);background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:10px}
  button{cursor:pointer;background:#0f1a14}
  .list{display:grid;gap:8px}
  .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:8px;padding:10px;background:#0b120e}
  .muted{color:var(--muted);font-size:12px}
  .hint{color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="brand">▮ Retro Chat · 大厅</div>
</header>
<main>
  <div class="card">
    <div class="row">
      <button id="createBtn">＋ 创建房间（8位ID）</button>
      <span class="hint">无房间时将自动创建并跳转</span>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>当前房间列表 <span class="muted">(每3秒自动刷新)</span></div>
      <button id="refreshBtn">手动刷新</button>
    </div>
    <div id="list" class="list" style="margin-top:10px"></div>
    <div id="empty" class="muted" style="display:none;margin-top:8px">暂无房间，将自动创建并进入…</div>
  </div>
</main>

<footer class="muted" style="padding:10px 16px;border-top:1px solid var(--line)">
  小贴士：复制进入后的链接发给对方，即可 1v1 私聊。
</footer>

<script>
const API_BASE = "https://chat-pmq6.onrender.com"; // Render 后端 HTTP 基础地址
const CHAT_PAGE = "chat.html";                      // 聊天页文件

function genRoomId(){ return Math.random().toString(36).slice(2,10); }

function gotoRoom(room){ location.href = `${CHAT_PAGE}?room=${encodeURIComponent(room)}`; }

// 拉取房间列表
async function fetchRooms(){
  try{
    const res = await fetch(`${API_BASE}/api/rooms`, {cache:'no-store'});
    if(!res.ok) throw new Error('bad status');
    const data = await res.json(); // 例如: ["abc12345","zz9xx001"]
    return Array.isArray(data) ? data : [];
  }catch{
    return [];
  }
}

const listEl = document.getElementById('list');
const emptyEl = document.getElementById('empty');

function renderList(rooms){
  listEl.innerHTML = '';
  if(rooms.length===0){
    emptyEl.style.display = '';
  }else{
    emptyEl.style.display = 'none';
  }
  rooms.forEach(id=>{
    const row = document.createElement('div');
    row.className='item';
    const left = document.createElement('div');
    left.textContent = id;
    const btn = document.createElement('button');
    btn.textContent = '进入';
    btn.onclick = ()=> gotoRoom(id);
    row.append(left, btn);
    listEl.appendChild(row);
  });
}

// 初始逻辑：如果没有任何房间，则自动创建并进入
async function init(){
  const rooms = await fetchRooms();
  renderList(rooms);
  if(rooms.length===0){
    const r = genRoomId();
    // 直接创建并进入（房间在首个客户端连接时才真正“出现”）
    gotoRoom(r);
  }
}
init();

// 自动刷新每3秒
setInterval(async ()=>{
  const rooms = await fetchRooms();
  renderList(rooms);
}, 3000);

// 手动刷新
document.getElementById('refreshBtn').onclick = init;

// 手动创建
document.getElementById('createBtn').onclick = ()=>{
  const r = genRoomId();
  gotoRoom(r);
};
</script>
</body>
</html>

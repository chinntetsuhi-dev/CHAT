<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Retro Chat · 大厅</title>
<style>
  :root{--bg:#0b0f0c;--panel:#0e1310;--line:#213b2a;--txt:#c7f7c1;--muted:#86b28d;--accent:#91ff75}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 ui-monospace,Consolas,monospace;min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
  header{padding:12px 16px;background:linear-gradient(180deg,#0e1712,#0a0f0c);border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
  .brand{color:var(--accent);font-weight:700;letter-spacing:.08em}
  main{padding:16px;display:grid;gap:14px;align-content:start}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:10px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button{font:inherit;color:var(--txt);background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:10px}
  button{cursor:pointer;background:#0f1a14}
  .list{display:grid;gap:8px}
  .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:8px;padding:10px;background:#0b120e}
  .muted{color:var(--muted);font-size:12px}
  .hint{color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="brand">▮ Retro Chat · 大厅</div>
</header>
<main>
  <!-- 手动创建 / 加入 -->
  <div class="card">
    <div class="row" style="gap:12px">
      <button id="createBtn">＋ 创建房间（8位ID）</button>
      <span class="hint">不会自动创建；你也可以输入已有房间ID并进入</span>
    </div>
    <div class="row" style="margin-top:10px;gap:8px">
      <input id="joinInput" placeholder="输入房间ID（8位）后进入" maxlength="16" style="min-width:260px">
      <button id="joinBtn">进入房间</button>
    </div>
  </div>

  <!-- 房间列表（只显示ID） -->
  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>当前房间列表 <span class="muted">(每3秒自动刷新)</span></div>
      <button id="refreshBtn">手动刷新</button>
    </div>
    <div id="list" class="list" style="margin-top:10px"></div>
    <div id="empty" class="muted" style="display:none;margin-top:8px">暂无房间。你可以手动创建一个。</div>
  </div>
</main>

<footer class="muted" style="padding:10px 16px;border-top:1px solid var(--line)">
  小贴士：进入房间后，复制地址栏链接发给对方即可 1v1 私聊。
</footer>

<script>
const API_BASE = "https://chat-pmq6.onrender.com"; // Render 后端 HTTP
const CHAT_PAGE = "chat.html";                      // 聊天页

function genRoomId(){ return Math.random().toString(36).slice(2,10); }
function gotoRoom(room){ location.href = `${CHAT_PAGE}?room=${encodeURIComponent(room)}`; }

// 拉取房间列表（只返回活跃房间ID）
async function fetchRooms(){
  try{
    const res = await fetch(`${API_BASE}/api/rooms`, {cache:'no-store'});
    if(!res.ok) throw new Error('bad status');
    const data = await res.json();
    return Array.isArray(data) ? data : [];
  }catch{
    return [];
  }
}

const listEl = document.getElementById('list');
const emptyEl = document.getElementById('empty');

function renderList(rooms){
  listEl.innerHTML = '';
  emptyEl.style.display = rooms.length ? 'none' : '';
  rooms.forEach(id=>{
    const row = document.createElement('div');
    row.className='item';
    const left = document.createElement('div');
    left.textContent = id;
    const btn = document.createElement('button');
    btn.textContent = '进入';
    btn.onclick = ()=> gotoRoom(id);
    row.append(left, btn);
    listEl.appendChild(row);
  });
}

// 初始化：仅加载列表，不自动创建
async function init(){
  renderList(await fetchRooms());
}
init();

// 自动刷新列表（每3秒）
setInterval(async ()=> renderList(await fetchRooms()), 3000);

// 手动刷新
document.getElementById('refreshBtn').onclick = init;

// 创建房间（8位随机码）
document.getElementById('createBtn').onclick = ()=>{
  const r = genRoomId();
  gotoRoom(r);
};

// 输入ID后加入
document.getElementById('joinBtn').onclick = ()=>{
  const v = (document.getElementById('joinInput').value || '').trim();
  if(!v){ alert('请输入房间ID'); return; }
  gotoRoom(v);
};
document.getElementById('joinInput').addEventListener('keydown', e=>{
  if(e.key==='Enter') document.getElementById('joinBtn').click();
});
</script>
</body>
</html>

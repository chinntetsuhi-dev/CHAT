<!doctype html>
<html lang="zh-CN">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Retro Chat (哲飞1.2版 请在拥有jvm环境下运行) </title>
<style>
  :root{--bg:#0b0f0c;--panel:#0e1310;--line:#213b2a;--txt:#c7f7c1;--muted:#86b28d;--accent:#91ff75}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 ui-monospace,Consolas,monospace;min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
  header{padding:12px 16px;background:linear-gradient(180deg,#0e1712,#0a0f0c);border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
  .brand{color:var(--accent);font-weight:700;letter-spacing:.08em}
  main{padding:16px;display:grid;gap:14px;align-content:start}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:10px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button{font:inherit;color:var(--txt);background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:10px}
  button{cursor:pointer;background:#0f1a14}
  .list{display:grid;gap:8px}
  .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:8px;padding:10px;background:#0b120e}
  .muted{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="brand">▮ Retro Chat · 大厅（手动版 vSAFE）</div>
</header>
<main>
  <div class="card">
    <div class="row" style="gap:12px">
      <button id="createBtn">＋ 创建房间（8位ID）</button>
      <span class="muted">不会自动跳转；只能手动进入</span>
    </div>
    <div class="row" style="margin-top:10px;gap:8px">
      <input id="joinInput" placeholder="输入房间ID（8位）" maxlength="16" style="min-width:260px">
      <button id="joinBtn">进入房间</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between">
      <div>当前房间列表</div>
      <button id="refreshBtn">刷新</button>
    </div>
    <div id="list" class="list" style="margin-top:10px"></div>
    <div id="empty" class="muted" style="display:none;margin-top:8px">暂无房间，请手动创建或输入ID。</div>
  </div>
</main>

<footer class="muted" style="padding:10px 16px;border-top:1px solid var(--line)">
  提示：进入房间后复制地址栏链接发给对方即可 1v1。
</footer>

<script>
console.log("LOBBY vSAFE"); // 用于确认你加载的是新版本

const API_BASE = "https://chat-pmq6.onrender.com"; // 仅用于线上拉列表；本地 file:// 下失败也无所谓
const CHAT_PAGE = "chat.html";

function genRoom(){ return Math.random().toString(36).slice(2,10); }
function gotoRoom(room){ location.href = `${CHAT_PAGE}?room=${encodeURIComponent(room)}`; }

// 列表（本地 file:// 打开时，拉接口可能会因为 CORS/网络失败，没关系，只是不显示列表）
async function fetchRooms(){
  try{
    const res = await fetch(`${API_BASE}/api/rooms`, {cache:'no-store'});
    if(!res.ok) throw new Error('bad status');
    const data = await res.json();
    return Array.isArray(data) ? data : [];
  }catch{
    return []; // 失败就当作没有房间，绝不自动创建/跳转
  }
}

const listEl = document.getElementById('list');
const emptyEl = document.getElementById('empty');

function renderList(rooms){
  listEl.innerHTML = '';
  emptyEl.style.display = rooms.length ? 'none' : '';
  rooms.forEach(id=>{
    const row = document.createElement('div');
    row.className='item';
    const left = document.createElement('div');
    left.textContent = id;
    const btn = document.createElement('button');
    btn.textContent = '进入';
    btn.onclick = ()=> gotoRoom(id);
    row.append(left, btn);
    listEl.appendChild(row);
  });
}

async function load(){ renderList(await fetchRooms()); }
document.getElementById('refreshBtn').onclick = load;
document.getElementById('createBtn').onclick = ()=> gotoRoom(genRoom());
document.getElementById('joinBtn').onclick = ()=>{
  const v = (document.getElementById('joinInput').value || '').trim();
  if(!v){ alert('请输入房间ID'); return; }
  gotoRoom(v);
};
document.getElementById('joinInput').addEventListener('keydown', e=>{
  if(e.key==='Enter') document.getElementById('joinBtn').click();
});

load(); // 只渲染列表，不自动进入
</script>
</body>
</html>

<!doctype html>
<html lang="ja">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Retro Chat（哲飛1.2版 ロビー）</title>
<style>
  :root{--bg:#0b0f0c;--panel:#0e1310;--line:#213b2a;--txt:#c7f7c1;--muted:#86b28d;--accent:#91ff75}
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--txt);font:16px/1.5 ui-monospace,Consolas,monospace;min-height:100dvh;display:grid;grid-template-rows:auto 1fr auto}
  header{padding:12px 16px;background:linear-gradient(180deg,#0e1712,#0a0f0c);border-bottom:1px solid var(--line);display:flex;gap:10px;align-items:center}
  .brand{color:var(--accent);font-weight:700;letter-spacing:.08em}
  main{padding:16px;display:grid;gap:14px;align-content:start}
  .card{border:1px solid var(--line);background:var(--panel);border-radius:10px;padding:14px}
  .row{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  input,button,select{font:inherit;color:var(--txt);background:var(--panel);border:1px solid var(--line);border-radius:8px;padding:10px}
  button{cursor:pointer;background:#0f1a14}
  .list{display:grid;gap:8px}
  .item{display:flex;justify-content:space-between;align-items:center;border:1px solid var(--line);border-radius:8px;padding:10px;background:#0b120e}
  .muted{color:var(--muted);font-size:12px}
</style>
</head>
<body>
<header>
  <div class="brand">▮ Retro Chat ロビー（哲飛1.2B）</div>
</header>
<main>
  <div class="card">
    <div class="row" style="gap:12px">
      <button id="createBtn">＋ ルームを作成（8桁ID）</button>
      <span class="muted">自動で移動しません。手動で入室してください。</span>
    </div>
    <div class="row" style="margin-top:10px;gap:8px">
      <input id="joinInput" placeholder="ルームIDを入力（8桁）" maxlength="16" style="min-width:260px">
      <button id="joinBtn">入室</button>
    </div>
  </div>

  <div class="card">
    <div class="row" style="justify-content:space-between;gap:12px">
      <div class="row">
        <div>ルーム一覧</div>
        <select id="scopeSel" title="フィルター範囲">
          <option value="active">オンラインのみ表示</option>
          <option value="all">すべてのルーム</option>
        </select>
      </div>
      <button id="refreshBtn">更新</button>
    </div>
    <div id="list" class="list" style="margin-top:10px"></div>
    <div id="empty" class="muted" style="display:none;margin-top:8px">ルームがありません。新規作成するかIDを入力してください。</div>
  </div>
</main>

<footer class="muted" style="padding:10px 16px;border-top:1px solid var(--line)">
  ヒント：ルーム入室後、アドレスバーのリンクを相手に送ると1対1チャットができます。
</footer>

<script>
console.log("LOBBY vSAFE-B");

const API_BASE = "https://chat-pmq6.onrender.com";
const CHAT_PAGE = "chat.html";

function genRoom(){ return Math.random().toString(36).slice(2,10); }
function gotoRoom(room){ location.href = `${CHAT_PAGE}?room=${encodeURIComponent(room)}`; }

async function fetchRooms(scope='active'){
  try{
    const res = await fetch(`${API_BASE}/api/rooms?scope=${encodeURIComponent(scope)}`, {cache:'no-store'});
    if(!res.ok) throw new Error('bad status');
    const data = await res.json();
    return Array.isArray(data) ? data : [];
  }catch{
    return [];
  }
}

const listEl = document.getElementById('list');
const emptyEl = document.getElementById('empty');
const scopeSel = document.getElementById('scopeSel');

function renderList(rooms){
  listEl.innerHTML = '';
  emptyEl.style.display = rooms.length ? 'none' : '';
  rooms.forEach(id=>{
    const row = document.createElement('div');
    row.className='item';
    const left = document.createElement('div');
    left.textContent = id;
    const btn = document.createElement('button');
    btn.textContent = '入る';
    btn.onclick = ()=> gotoRoom(id);
    row.append(left, btn);
    listEl.appendChild(row);
  });
}

async function load(){
  const scope = scopeSel.value;
  const rooms = await fetchRooms(scope);
  renderList(rooms);
}

document.getElementById('refreshBtn').onclick = load;
document.getElementById('createBtn').onclick = ()=> gotoRoom(genRoom());
document.getElementById('joinBtn').onclick = ()=>{
  const v = (document.getElementById('joinInput').value || '').trim();
  if(!v){ alert('ルームIDを入力してください'); return; }
  gotoRoom(v);
};
document.getElementById('joinInput').addEventListener('keydown', e=>{
  if(e.key==='Enter') document.getElementById('joinBtn').click();
});
scopeSel.addEventListener('change', load);

load();
</script>
</body>
</html>
